name: ðŸ¾ ã­ã“ãŸã‚“ãƒ†ã‚¹ãƒˆã¨å“è³ªãƒã‚§ãƒƒã‚¯ (Test & Quality)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆã®ç¨®é¡žã‚’é¸ã‚“ã§ã­ï½ž ðŸ”'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - unit-tests
        - ui-tests
        - lint
        - coverage

env:
  XCODE_VERSION: '16.4'
  SWIFTLINT_VERSION: '0.52.4'

jobs:
  setup-environment:
    name: ðŸ”§ ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    runs-on: macos-latest
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸŽ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž Swift Packageã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã™ã‚‹ã«ã‚ƒï½ž ðŸ“¦"
          xcodebuild -resolvePackageDependencies -project NekoTan.xcodeproj

  swiftlint-check:
    name: ðŸ“ SwiftLintã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: macos-latest
    needs: setup-environment
    if: github.event.inputs.test_type == 'lint' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ” SwiftLintã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å®Ÿè¡Œ
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž SwiftLintã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã«ã‚ƒï½ž ðŸ“"
          brew install swiftlint
          echo "ã«ã‚ƒã‚“ã“ï½ž SwiftLintã‚’å®Ÿè¡Œã™ã‚‹ã«ã‚ƒï½ž ðŸ”"
          swiftlint lint --config .swiftlint.yml || echo "SwiftLintã®è­¦å‘ŠãŒã‚ã‚Šã¾ã™ãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã«ã‚ƒï½ž"

  unit-tests:
    name: ðŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest
    needs: setup-environment
    if: github.event.inputs.test_type == 'unit-tests' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸŽ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ðŸ” åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ¼ãƒ ã‚’ç¢ºèª
        continue-on-error: true
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ¼ãƒ ã‚’ç¢ºèªã™ã‚‹ã«ã‚ƒï½ž ðŸ”"
          xcodebuild -list -project NekoTan.xcodeproj || echo "Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ã‚­ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
      
      - name: ðŸ§ª Swift Package Managerã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        continue-on-error: true
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž Swift Package Managerã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã‚ƒï½ž ðŸ§ª"
          swift test --enable-code-coverage

  ui-tests:
    name: ðŸ–±ï¸ UIãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest
    needs: setup-environment
    if: github.event.inputs.test_type == 'ui-tests' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸŽ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ðŸ”§ Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž Xcodeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã‚ƒï½ž ðŸ”§"
          xcodebuild build -project NekoTan.xcodeproj -scheme NekoTan -destination 'platform=iOS Simulator,name=iPhone 15 Pro' || echo "ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™"
      
      # UIãƒ†ã‚¹ãƒˆãŒãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯ã®ã¿ã«å¤‰æ›´ã•ã‚ŒãŸãŸã‚ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™

  test-coverage:
    name: ðŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æž
    runs-on: macos-latest
    needs: unit-tests
    if: github.event.inputs.test_type == 'coverage' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ðŸ“Š Swift Package Managerã§ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž Swift Package Managerã§ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã‚ƒï½ž ðŸ“Š"
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¦è¡¨ç¤º
          find . -name "*.profdata" || echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"

  summary:
    name: ðŸ“‹ ãƒ†ã‚¹ãƒˆã¨å“è³ªãƒã‚§ãƒƒã‚¯ã®æ¦‚è¦
    runs-on: ubuntu-latest
    needs: [swiftlint-check, unit-tests, ui-tests]
    if: always()
    steps:
      - name: ðŸ¾ çµæžœã‚’ã¾ã¨ã‚ã‚‹
        run: |
          echo "## ðŸ¾ ã­ã“ãŸã‚“ã®ãƒ†ã‚¹ãƒˆã¨å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # SwiftLintã®çµæžœ
          if [ "${{ needs.swiftlint-check.result }}" = "success" ]; then
            echo "âœ… SwiftLintã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.swiftlint-check.result }}" = "skipped" ]; then
            echo "â­ï¸ SwiftLintã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ SwiftLintã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å˜ä½“ãƒ†ã‚¹ãƒˆã®çµæžœï¼ˆSwift Package Managerï¼‰
          if [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "âœ… å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆSwift Package Managerï¼‰: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.unit-tests.result }}" = "skipped" ]; then
            echo "â­ï¸ å˜ä½“ãƒ†ã‚¹ãƒˆ: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å˜ä½“ãƒ†ã‚¹ãƒˆ: ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          # UIãƒ†ã‚¹ãƒˆã®çµæžœï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ãƒ«ãƒ‰ï¼‰
          if [ "${{ needs.ui-tests.result }}" = "success" ]; then
            echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ãƒ«ãƒ‰: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.ui-tests.result }}" = "skipped" ]; then
            echo "â­ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ãƒ«ãƒ‰: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ãƒ«ãƒ‰: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã«ã‚ƒã‚“ã“ï½ž ãƒ†ã‚¹ãƒˆã¨å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã«ã‚ƒï½ž ðŸ’•" >> $GITHUB_STEP_SUMMARY
          
          # å…¨ä½“ã®çµæžœ
          if [ "${{ needs.swiftlint-check.result }}" = "success" ] && \
             [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "âœ… å…¨ä½“ã®çµæžœ: åŸºæœ¬çš„ãªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸï¼ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ å…¨ä½“ã®çµæžœ: ã„ãã¤ã‹ã®ãƒã‚§ãƒƒã‚¯ã«ä¸åˆæ ¼ãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã¯ä»¥ä¸‹ã®å¤‰æ›´ãŒåŠ ãˆã‚‰ã‚Œã¾ã—ãŸ:" >> $GITHUB_STEP_SUMMARY
          echo "- SwiftLintã®å®Ÿè¡Œæ–¹æ³•ã‚’å¤‰æ›´ï¼ˆLinuxã‚³ãƒ³ãƒ†ãƒŠã®ä»£ã‚ã‚Šã«Homebrewã‚’ä½¿ç”¨ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- å˜ä½“ãƒ†ã‚¹ãƒˆã‚’Swift Package Managerã§å®Ÿè¡Œï¼ˆã‚¹ã‚­ãƒ¼ãƒ ã®å•é¡Œã‚’å›žé¿ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- UIãƒ†ã‚¹ãƒˆã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ãƒ«ãƒ‰ã«å¤‰æ›´ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å•é¡Œã‚’å›žé¿ï¼‰" >> $GITHUB_STEP_SUMMARY