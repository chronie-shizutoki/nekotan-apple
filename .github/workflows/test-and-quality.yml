name: ðŸ¾ ã­ã“ãŸã‚“ãƒ†ã‚¹ãƒˆã¨å“è³ªãƒã‚§ãƒƒã‚¯ (Test & Quality)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆã®ç¨®é¡žã‚’é¸ã‚“ã§ã­ï½ž ðŸ”'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - unit-tests
        - ui-tests
        - lint
        - coverage

env:
  XCODE_VERSION: '16.4'
  SWIFTLINT_VERSION: '0.52.4'

jobs:
  setup-environment:
    name: ðŸ”§ ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    runs-on: macos-latest
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸŽ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž Swift Packageã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã™ã‚‹ã«ã‚ƒï½ž ðŸ“¦"
          xcodebuild -resolvePackageDependencies -project NekoTan.xcodeproj

  swiftlint-check:
    name: ðŸ“ SwiftLintã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: macos-latest
    needs: setup-environment
    if: github.event.inputs.test_type == 'lint' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ” SwiftLintã‚’å®Ÿè¡Œ
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --config .swiftlint.yml

  unit-tests:
    name: ðŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest
    needs: setup-environment
    if: github.event.inputs.test_type == 'unit-tests' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸŽ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ðŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã‚ƒï½ž ðŸ§ª"
          xcodebuild test -scheme NekoTanLib -destination 'platform=iOS Simulator,name=iPhone 15 Pro' -enableCodeCoverage YES
      
      - name: ðŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã‚ƒï½ž ðŸ“Š"
          mkdir -p build/Logs/Test
          find . -name "*.xcresult" -exec cp -R {} build/Logs/Test/ \;
          xcrun xccov view --report --json build/Logs/Test/*.xcresult > coverage-report.json
          echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®æœ€åˆã®10è¡Œã‚’è¡¨ç¤ºã™ã‚‹ã«ã‚ƒï½ž"
          head -n 10 coverage-report.json || echo "ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã«ã‚ƒï½ž"
      
      - name: ðŸ’¾ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage-report
          path: coverage-report.json
          retention-days: 30

  ui-tests:
    name: ðŸ–±ï¸ UIãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest
    needs: setup-environment
    if: github.event.inputs.test_type == 'ui-tests' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸŽ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ðŸ“± ä½¿ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèª
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž ä½¿ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèªã™ã‚‹ã«ã‚ƒï½ž ðŸ“±"
          xcrun simctl list devices
      
      - name: ðŸ–±ï¸ UIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž UIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã‚ƒï½ž ðŸ–±ï¸"
          xcodebuild test -scheme NekoTanLib -destination 'platform=iOS Simulator,name=iPhone 15 Pro'
      
      - name: ðŸ“¸ ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-screenshots
          path: /Users/runner/Library/Developer/Xcode/DerivedData/**/TestProducts/**/Products/**/*.png
          retention-days: 30

  test-coverage:
    name: ðŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æž
    runs-on: macos-latest
    needs: unit-tests
    if: github.event.inputs.test_type == 'coverage' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null
    steps:
      - name: ðŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ðŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’åˆ†æž
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ž ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’åˆ†æžã™ã‚‹ã«ã‚ƒï½ž ðŸ“Š"
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          gem install slather
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          slather coverage \
            --input-format xccov \
            --output-directory coverage \
            --html \
            --scheme NekoTanLib
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ¦‚è¦ã‚’è¡¨ç¤º
          echo "ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ¦‚è¦ã‚’è¡¨ç¤ºã™ã‚‹ã«ã‚ƒï½ž"
          cat coverage/index.html | grep -A 10 "Total Coverage"
      
      - name: ðŸ’¾ HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: html-coverage-report
          path: coverage/
          retention-days: 30

  summary:
    name: ðŸ“‹ ãƒ†ã‚¹ãƒˆã¨å“è³ªãƒã‚§ãƒƒã‚¯ã®æ¦‚è¦
    runs-on: ubuntu-latest
    needs: [swiftlint-check, unit-tests, ui-tests, test-coverage]
    if: always()
    steps:
      - name: ðŸ¾ çµæžœã‚’ã¾ã¨ã‚ã‚‹
        run: |
          echo "## ðŸ¾ ã­ã“ãŸã‚“ã®ãƒ†ã‚¹ãƒˆã¨å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # SwiftLintã®çµæžœ
          if [ "${{ needs.swiftlint-check.result }}" = "success" ]; then
            echo "âœ… SwiftLintã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.swiftlint-check.result }}" = "skipped" ]; then
            echo "â­ï¸ SwiftLintã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ SwiftLintã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å˜ä½“ãƒ†ã‚¹ãƒˆã®çµæžœ
          if [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "âœ… å˜ä½“ãƒ†ã‚¹ãƒˆ: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.unit-tests.result }}" = "skipped" ]; then
            echo "â­ï¸ å˜ä½“ãƒ†ã‚¹ãƒˆ: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å˜ä½“ãƒ†ã‚¹ãƒˆ: ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          # UIãƒ†ã‚¹ãƒˆã®çµæžœ
          if [ "${{ needs.ui-tests.result }}" = "success" ]; then
            echo "âœ… UIãƒ†ã‚¹ãƒˆ: åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.ui-tests.result }}" = "skipped" ]; then
            echo "â­ï¸ UIãƒ†ã‚¹ãƒˆ: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ UIãƒ†ã‚¹ãƒˆ: ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æžã®çµæžœ
          if [ "${{ needs.test-coverage.result }}" = "success" ]; then
            echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æž: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-coverage.result }}" = "skipped" ]; then
            echo "â­ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æž: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æž: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã«ã‚ƒã‚“ã“ï½ž ãƒ†ã‚¹ãƒˆã¨å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã«ã‚ƒï½ž ðŸ’•" >> $GITHUB_STEP_SUMMARY
          
          # å…¨ä½“ã®çµæžœ
          if [ "${{ needs.swiftlint-check.result }}" = "success" ] && \
             [ "${{ needs.unit-tests.result }}" = "success" ] && \
             [ "${{ needs.ui-tests.result }}" = "success" ]; then
            echo "âœ… å…¨ä½“ã®çµæžœ: ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸï¼ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ å…¨ä½“ã®çµæžœ: ã„ãã¤ã‹ã®ãƒã‚§ãƒƒã‚¯ã«ä¸åˆæ ¼ãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi