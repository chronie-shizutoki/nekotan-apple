name: ğŸ¾ ã­ã“ãŸã‚“ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰ (Build NekoTan Apps)

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      platform:
        description: 'ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’é¸ã‚“ã§ã­ï½ ğŸ'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ios
        - macos
        - ipados

env:
  XCODE_VERSION: '16.4'
  IOS_DEPLOYMENT_TARGET: '15.0'
  MACOS_DEPLOYMENT_TARGET: '12.0'
  IPADOS_DEPLOYMENT_TARGET: '15.0'

jobs:
  build-ios:
    name: ğŸ“± iOSã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: macos-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' || github.event.inputs.platform == null
    steps:
      - name: ğŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ğŸ“± åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèª
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèªã™ã‚‹ã«ã‚ƒï½ ğŸ”"
          xcrun simctl list devices
      
      - name: ğŸ“± iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ãƒ“ãƒ«ãƒ‰
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ iOSã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã‚ƒï½ âœ¨"
          xcodebuild -project NekoTan.xcodeproj \
            -scheme NekoTan \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=18.6' \
            -configuration Debug \
            clean build
      
      - name: ğŸ“¦ iOSã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
        run: |
          echo "iOSã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆä¸­ã«ã‚ƒã‚“ï½ ğŸ“¦"
          xcodebuild -project NekoTan.xcodeproj \
            -scheme NekoTan \
            -destination generic/platform=iOS \
            -configuration Release \
            archive -archivePath build/NekoTan-iOS.xcarchive
      
      - name: ğŸ’¾ iOSãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: nekotan-ios-build
          path: build/NekoTan-iOS.xcarchive
          retention-days: 30

  build-ipados:
    name: ğŸ“± iPadOSã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: macos-latest
    if: github.event.inputs.platform == 'ipados' || github.event.inputs.platform == 'all' || github.event.inputs.platform == null
    steps:
      - name: ğŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ğŸ“± åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèª
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç¢ºèªã™ã‚‹ã«ã‚ƒï½ ğŸ”"
          xcrun simctl list devices
      
      - name: ğŸ“± iPadOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ãƒ“ãƒ«ãƒ‰
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ iPadOSã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã‚ƒï½ âœ¨"
          xcodebuild -project NekoTan.xcodeproj \
            -scheme NekoTan \
            -destination 'platform=iOS Simulator,name=iPad Pro 13-inch (M4),OS=18.6' \
            -configuration Debug \
            clean build
      
      - name: ğŸ“¦ iPadOSã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
        run: |
          echo "iPadOSã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆä¸­ã«ã‚ƒã‚“ï½ ğŸ“¦"
          xcodebuild -project NekoTan.xcodeproj \
            -scheme NekoTan \
            -destination generic/platform=iOS \
            -configuration Release \
            archive -archivePath build/NekoTan-iPadOS.xcarchive
      
      - name: ğŸ’¾ iPadOSãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: nekotan-ipados-build
          path: build/NekoTan-iPadOS.xcarchive
          retention-days: 30

  build-macos:
    name: ğŸ’» macOSã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: macos-latest
    if: github.event.inputs.platform == 'macos' || github.event.inputs.platform == 'all' || github.event.inputs.platform == null
    steps:
      - name: ğŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ğŸ’» macOSã§ãƒ“ãƒ«ãƒ‰
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ macOSã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã‚ƒï½ âœ¨"
          xcodebuild -project NekoTan.xcodeproj \
            -scheme NekoTan \
            -configuration Debug \
            clean build
      
      - name: ğŸ“¦ macOSã‚¢ãƒ—ãƒªä½œæˆ
        run: |
          echo "macOSã‚¢ãƒ—ãƒªã‚’ä½œæˆä¸­ã«ã‚ƒã‚“ï½ ğŸ“¦"
          xcodebuild -project NekoTan.xcodeproj \
            -scheme NekoTan \
            -configuration Release \
            -destination 'platform=macOS' \
            build
      
      - name: ğŸ’¾ macOSãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: nekotan-macos-build
          path: build/Release
          retention-days: 30

  build-maccatalyst:
    name: ğŸª Mac Catalystã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: macos-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == null
    steps:
      - name: ğŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Xcodeç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      
      - name: ğŸª Mac Catalystã§ãƒ“ãƒ«ãƒ‰
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ Mac Catalystã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã‚ƒï½ âœ¨"
          xcodebuild -project NekoTan.xcodeproj \
            -scheme NekoTan \
            -destination 'platform=macOS,variant=Mac Catalyst' \
            -configuration Debug \
            clean build
      
      - name: ğŸ’¾ Mac Catalystãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: nekotan-maccatalyst-build
          path: build/Release
          retention-days: 30

  package-apps:
    name: ğŸ“¦ ã‚¢ãƒ—ãƒªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
    runs-on: macos-latest
    needs: [build-ios, build-ipados, build-macos, build-maccatalyst]
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == null
    steps:
      - name: ğŸ¾ ã­ã“ãŸã‚“ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ“± iOSãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: nekotan-ios-build
          path: artifacts/ios
      
      - name: ğŸ“± iPadOSãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: nekotan-ipados-build
          path: artifacts/ipados
      
      - name: ğŸ’» macOSãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: nekotan-macos-build
          path: artifacts/macos
      
      - name: ğŸª Mac Catalystãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: nekotan-maccatalyst-build
          path: artifacts/maccatalyst
      
      - name: ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ ã‚¢ãƒ—ãƒªã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã™ã‚‹ã«ã‚ƒï½ ğŸ“¦âœ¨"
          mkdir -p packages
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          BUILD_DATE=$(date +"%Y%m%d-%H%M%S")
          
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"
          echo "ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: $BUILD_DATE"
          
          # æˆæœç‰©ã‚’ã¾ã¨ã‚ã‚‹
          tar -czf "packages/nekotan-${VERSION}-${BUILD_DATE}-all-platforms.tar.gz" \
            artifacts/ \
            README.md \
            LICENSE \
            Package.swift
      
      - name: ğŸ’¾ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æˆæœç‰©ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: nekotan-package-all
          path: packages/
          retention-days: 90

  notify-success:
    name: ğŸ‰ æˆåŠŸé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-ios, build-ipados, build-macos, build-maccatalyst]
    if: success()
    steps:
      - name: ğŸ¾ æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ ã™ã¹ã¦ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ãƒ“ãƒ«ãƒ‰æˆåŠŸã ã«ã‚ƒï½ âœ¨ğŸ‰"
          echo "iOS: âœ…"
          echo "iPadOS: âœ…"
          echo "macOS: âœ…"
          echo "Mac Catalyst: âœ…"
          echo "ãŠç–²ã‚Œæ§˜ã«ã‚ƒã‚“ï½ ğŸ’•"

  notify-failure:
    name: ğŸ˜¿ å¤±æ•—é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-ios, build-ipados, build-macos, build-maccatalyst]
    if: failure()
    steps:
      - name: ğŸ¾ å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        run: |
          echo "ã«ã‚ƒã‚“ã“ï½ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã«ã‚ƒï½ ğŸ˜¿"
          echo "ã§ã‚‚å¤§ä¸ˆå¤«ï¼ã¾ãŸé ‘å¼µã‚‹ã«ã‚ƒã‚“ ğŸ’ª"
          echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã€ã©ã“ãŒå•é¡Œã‹èª¿ã¹ã¦ã¿ã¦ã­ï½ ğŸ”"
